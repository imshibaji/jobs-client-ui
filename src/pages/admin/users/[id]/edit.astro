---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { useHttpClient } from "@/utils/useHttpClient";
import { User } from "@/utils/types/User";
import { APP_URL } from "astro:env/server";

const { id } = Astro.params;
const token = Astro.cookies.get('token')?.value as string;
// Capture the backUrl query param to return the user to the correct list/view page
const backUrl = Astro.url.searchParams.get('backUrl') || '/admin/users';

let errorMessage: string | null = null;
let successMessage: string | null = null;
let user: User | null = null;

// 1. FETCH EXISTING USER DATA (GET)
try {
    user = await useHttpClient(token).get(APP_URL + `/users/${id}`).then(res => res.json()) as User;
} catch (error) {
    console.error("Failed to fetch user data:", error);
    return Astro.redirect('/admin/users?error=userNotFound');
}

if (!user) {
    return Astro.redirect('/admin/users?error=userNotFound');
}

// 2. HANDLE FORM SUBMISSION (POST -> PUT)
if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        
        // Extract fields
        const name = formData.get('name') as string;
        const email = formData.get('email') as string;
        const phoneNumber = formData.get('phoneNumber') as string;
        const role = formData.get('role') as string;
        const status = formData.get('status') as string;
        
        // Social Media
        const instagramId = formData.get('instagramId') as string;
        const facebookId = formData.get('facebookId') as string;
        const youtubeId = formData.get('youtubeId') as string;
        const linkedinId = formData.get('linkedinId') as string;
        const githubId = formData.get('githubId') as string;
        
        // Security
        const password = formData.get('password') as string;
        const confirmPassword = formData.get('confirmPassword') as string;
        
        // Image
        const imageFile = formData.get('imageFile') as File;

        // Validation: Check passwords match ONLY if a password was entered
        if (password && password !== confirmPassword) {
            errorMessage = "Passwords do not match.";
        } else {
            // Prepare Payload
            // We only include the password if the user actually typed something
            const payload: any = {
                name, email, phoneNumber, role, status,
                instagramId, facebookId, youtubeId, linkedinId, githubId
            };

            if (password) {
                // Placeholder for encrypting password
                const getEncryptedPassword = async (password: string) => {
                    const encPassword = await useHttpClient(token).post(APP_URL + `/auth/encrypt-password/`, { password }).then(res => res.json());
                    return encPassword;
                }
                const encryptedPassword = (await getEncryptedPassword(password)) as { encryptedText: string };
                console.log(encryptedPassword);
                
                // Placeholder for sending data to the API
                payload.password = encryptedPassword.encryptedText;
            }

            // In a real app, you would handle the file upload here (e.g., send FormData directly)
            // For this example, we assume we send JSON or handle the file separately.
            // File upload logic (if needed)
            if (imageFile && imageFile.name) {
                const userData = payload as User;
                const formData = new FormData();
                formData.append('folder', 'pictures');
                formData.append('customName', 'user-'+id+'-profile-picture');
                formData.append('file', imageFile);

                const uploadResponse = await useHttpClient(token).upload(APP_URL + `/upload/`, formData);

                // Handle image upload response (if needed)
                if (!uploadResponse.ok) {
                    console.error("Image upload failed:", uploadResponse);
                    errorMessage = "Image upload failed.";
                }
        
                // update the user image
                const imageObject = await uploadResponse.json();
                payload.image = imageObject.filename;
            }

            // Perform PUT request to update specific user
            const response = await useHttpClient(token).put(APP_URL + `/users/${id}`, payload);

            if (response.ok) {
                successMessage = "User updated successfully!";
                // Redirect back to the view page or list page
                return Astro.redirect(backUrl);
            } else {
                const errorData = await response.json();
                errorMessage = errorData.message || "Failed to update user.";
            }
        }
    } catch (error) {
        console.error("Update error:", error);
        errorMessage = "An unexpected error occurred during update.";
    }
}
---

<AdminLayout>
  <div class="mt-4 max-w-5xl mx-auto">
    
    <!-- Header with Back Button -->
    <div class="flex items-center justify-between mb-6 border-b pb-3">
        <h2 class="text-3xl font-extrabold text-violet-700">Edit User: {user.name}</h2>
        <a 
            href={backUrl}
            class="inline-flex items-center px-4 py-2 border border-violet-300 text-sm font-medium rounded-lg text-violet-700 bg-white hover:bg-violet-50 transition duration-150 ease-in-out shadow-sm"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Cancel & Back
        </a>
    </div>

    <!-- Feedback Messages -->
    {errorMessage && (
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{errorMessage}</span>
        </div>
    )}
    {successMessage && (
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{successMessage}</span>
        </div>
    )}

    <!-- Main Form -->
    <form method="POST" enctype="multipart/form-data" class="bg-white rounded-xl shadow-2xl overflow-hidden p-8">
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- LEFT COLUMN: Image & Status -->
        <div class="lg:col-span-1 border-r pr-6 border-gray-100">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Profile Image</h3>
            <div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg border border-gray-200">
                <!-- Image Preview (Shows existing user image by default) -->
                <img 
                    id="profileImagePreview"
                    src={user.image ? `${APP_URL}/file/view?filename=${user.image}` : "https://placehold.co/128x128/f3f4f6/374151?text=User"} 
                    alt="Profile Preview" 
                    class="w-32 h-32 rounded-full object-cover mb-4 border-4 border-white shadow-md bg-white"
                />
                
                <label for="imageFile" class="cursor-pointer bg-violet-500 hover:bg-violet-600 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                    Change Photo
                </label>
                <input 
                    type="file" 
                    id="imageFile" 
                    name="imageFile" 
                    accept="image/*" 
                    class="hidden" 
                    onchange="document.getElementById('profileImagePreview').src = window.URL.createObjectURL(this.files[0])"
                />
                <p class="text-xs text-gray-400 mt-2">Leave empty to keep current photo</p>
            </div>
            
            <div class="mt-6 space-y-4">
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select id="role" name="role" required class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm">
                      <option value="user" selected={user.role === 'user'}>User</option>
                      <option value="employer" selected={user.role === 'employer'}>Employer</option>
                      <option value="editor" selected={user.role === 'editor'}>Editor</option>
                      <option value="admin" selected={user.role === 'admin'}>Admin</option>
                    </select>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="status" name="status" required class="w-full border border-gray-300 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm">
                      <option value="active" selected={user.status === 'active'}>Active</option>
                      <option value="inactive" selected={user.status === 'inactive'}>Inactive</option>
                      <option value="suspended" selected={user.status === 'suspended'}>Suspended</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMNS: Info -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Basic Information -->
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Basic Information</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="name" name="name" value={user.name} required class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" name="email" value={user.email} required class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                    <input type="text" id="phoneNumber" name="phoneNumber" value={user.phoneNumber} class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
            </div>

            <!-- Security (Optional Update) -->
            <h3 class="text-lg font-semibold text-gray-800 mt-8 border-b pb-2">Security <span class="text-xs font-normal text-gray-500 ml-2">(Leave blank to keep current password)</span></h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                    <input type="password" id="password" name="password" placeholder="••••••••" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="••••••••" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
            </div>

            <!-- Social Media / Links -->
            <h3 class="text-lg font-semibold text-gray-800 mt-8 border-b pb-2">Social Media / Links</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="instagramId" class="block text-sm font-medium text-gray-700 mb-1">Instagram Id</label>
                    <input type="text" id="instagramId" name="instagramId" value={user.instagramId} class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="facebookId" class="block text-sm font-medium text-gray-700 mb-1">Facebook Id</label>
                    <input type="text" id="facebookId" name="facebookId" value={user.facebookId} class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="youtubeId" class="block text-sm font-medium text-gray-700 mb-1">Youtube Id</label>
                    <input type="text" id="youtubeId" name="youtubeId" value={user.youtubeId} class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="linkedinId" class="block text-sm font-medium text-gray-700 mb-1">LinkedIn Id</label>
                    <input type="text" id="linkedinId" name="linkedinId" value={user.linkedinId} class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
                <div>
                    <label for="githubId" class="block text-sm font-medium text-gray-700 mb-1">Github Id</label>
                    <input type="text" id="githubId" name="githubId" value={user.githubId} class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 shadow-sm" />
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4 pt-6 border-t mt-8">
                <button 
                    type="submit" 
                    class="flex-1 bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out"
                >
                    Update User
                </button>
                <a 
                    href={backUrl}
                    class="flex-1 text-center bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out"
                >
                    Cancel
                </a>
            </div>
        </div>
        
      </div>
    </form>
  </div>
</AdminLayout>