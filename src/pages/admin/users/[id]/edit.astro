---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { useHttpClient } from "@/utils/useHttpClient";
import { User } from "@/utils/types/User";
import { APP_URL } from "astro:env/server";
import UserForm from "../_parts/UserForm.astro";

const { id } = Astro.params;
const token = Astro.cookies.get('token')?.value as string;
// Capture the backUrl query param to return the user to the correct list/view page
const backUrl = Astro.url.searchParams.get('backUrl') || '/admin/users';

let errorMessage: string | null = null;
let successMessage: string | null = null;
let user: User | null = null;

// 1. FETCH EXISTING USER DATA (GET)
try {
    user = await useHttpClient(token).get(APP_URL + `/users/${id}`).then(res => res.json()) as User;
} catch (error) {
    console.error("Failed to fetch user data:", error);
    return Astro.redirect('/admin/users?error=userNotFound');
}

if (!user) {
    return Astro.redirect('/admin/users?error=userNotFound');
}

// 2. HANDLE FORM SUBMISSION (POST -> PUT)
if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        
        // Extract fields
        const name = formData.get('name') as string;
        const email = formData.get('email') as string;
        const phoneNumber = formData.get('phoneNumber') as string;
        const role = formData.get('role') as string;
        const status = formData.get('status') as string;
        
        // Social Media
        const instagramId = formData.get('instagramId') as string;
        const facebookId = formData.get('facebookId') as string;
        const youtubeId = formData.get('youtubeId') as string;
        const linkedinId = formData.get('linkedinId') as string;
        const githubId = formData.get('githubId') as string;
        
        // Security
        const password = formData.get('password') as string;
        const confirmPassword = formData.get('confirmPassword') as string;
        
        // Image
        const imageFile = formData.get('imageFile') as File;

        // Validation: Check passwords match ONLY if a password was entered
        if (password && password !== confirmPassword) {
            errorMessage = "Passwords do not match.";
        } else {
            // Prepare Payload
            // We only include the password if the user actually typed something
            const payload: any = {
                name, email, phoneNumber, role, status,
                instagramId, facebookId, youtubeId, linkedinId, githubId
            };

            if (password) {
                // Placeholder for encrypting password
                const getEncryptedPassword = async (password: string) => {
                    const encPassword = await useHttpClient(token).post(APP_URL + `/auth/encrypt-password/`, { password }).then(res => res.json());
                    return encPassword;
                }
                const encryptedPassword = (await getEncryptedPassword(password)) as { encryptedText: string };
                console.log(encryptedPassword);
                
                // Placeholder for sending data to the API
                payload.password = encryptedPassword.encryptedText;
            }

            // In a real app, you would handle the file upload here (e.g., send FormData directly)
            // For this example, we assume we send JSON or handle the file separately.
            // File upload logic (if needed)
            if (imageFile && imageFile.name) {
                const userData = payload as User;
                const formData = new FormData();
                formData.append('folder', 'pictures');
                formData.append('customName', 'user-'+id+'-profile-picture');
                formData.append('file', imageFile);

                const uploadResponse = await useHttpClient(token).upload(APP_URL + `/upload/`, formData);

                // Handle image upload response (if needed)
                if (!uploadResponse.ok) {
                    console.error("Image upload failed:", uploadResponse);
                    errorMessage = "Image upload failed.";
                }
        
                // update the user image
                const imageObject = await uploadResponse.json();
                payload.image = imageObject.filename;
            }

            // Perform PUT request to update specific user
            const response = await useHttpClient(token).put(APP_URL + `/users/${id}`, payload);

            if (response.ok) {
                successMessage = "User updated successfully!";
                // Redirect back to the view page or list page
                return Astro.redirect(backUrl);
            } else {
                const errorData = await response.json();
                errorMessage = errorData.message || "Failed to update user.";
            }
        }
    } catch (error) {
        console.error("Update error:", error);
        errorMessage = "An unexpected error occurred during update.";
    }
}
---

<AdminLayout>
  <div class="mt-4 max-w-5xl mx-auto">
    
    <!-- Header with Back Button -->
    <div class="flex items-center justify-between mb-6 border-b pb-3">
        <h2 class="text-3xl font-extrabold text-violet-700">Edit User: {user.name}</h2>
        <a 
            href={backUrl}
            class="inline-flex items-center px-4 py-2 border border-violet-300 text-sm font-medium rounded-lg text-violet-700 bg-white hover:bg-violet-50 transition duration-150 ease-in-out shadow-sm"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Cancel & Back
        </a>
    </div>

    <!-- Feedback Messages -->
    {errorMessage && (
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{errorMessage}</span>
        </div>
    )}
    {successMessage && (
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <span class="block sm:inline">{successMessage}</span>
        </div>
    )}

    <!-- Main Form -->
    <form method="POST" enctype="multipart/form-data" class="bg-white rounded-xl shadow-2xl overflow-hidden p-8">
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <UserForm
            name={user.name}
            email={user.email}
            phoneNumber={user.phoneNumber}
            password={user.password}
            confirmPassword={user.password}
            role={user.role}
            status={user.status}
            instagramId={user.instagramId}
            facebookId={user.facebookId}
            youtubeId={user.youtubeId}
            linkedinId={user.linkedinId}
            githubId={user.githubId}
            backUrl={backUrl}
            isEdit={true}
            initialImageUrl={user.image ? `${APP_URL}/file/view?filename=${user.image}` : "https://placehold.co/128x128/f3f4f6/374151?text=User"}
        />
        
      </div>
    </form>
  </div>
</AdminLayout>