---
import { User } from '@/utils/types/User';

interface Props {
  // We pass the entire user list as a string to preserve the data integrity 
  // during Astro's build process, then parse it in client-side JS.
  usersJson: string; 
  itemsPerPage?: number;
}
const { usersJson, itemsPerPage } = Astro.props;

---

<div id="user-table-wrapper" class="mt-4 max-w-full mx-auto">
  <!-- Header Section -->
  <div class="flex flex-col md:flex-row items-center justify-between mb-6 pb-2 border-b border-gray-200 gap-4">
    <h2 class="text-3xl font-extrabold text-gray-900 hidden md:block">All System Users</h2>
    
    <!-- Search Bar -->
    <div class="w-full max-w-lg relative flex items-center text-purple-400 focus-within:text-gray-600 order-2 md:order-1">
      <span class="absolute left-4 h-5 flex items-center pl-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </span>
      <input 
        type="text" 
        id="user-search-input"
        placeholder="Search by name, email, or phone number..."
        class="block w-full py-2 pl-10 pr-3 border border-purple-200 rounded-lg focus:ring-violet-500 focus:border-violet-500 sm:text-sm shadow-sm"
      />
    </div>
    
    <!-- Create New User Button -->
    <div class="w-full md:w-auto flex justify-end order-1 md:order-2">
        <a 
            href="/admin/users/create" 
            class="inline-flex w-full md:w-auto items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-violet-600 hover:bg-violet-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500 transition duration-150 ease-in-out"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            Create New User
        </a>
    </div>
  </div>


  <!-- Table Card Container -->
  <div class="bg-white rounded-xl shadow-2xl overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      
      <!-- Table Header -->
      <thead class="bg-violet-100">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-semibold text-violet-700 uppercase tracking-wider rounded-tl-xl">Name</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-violet-700 uppercase tracking-wider">Email</th>
          <th class="hidden sm:table-cell px-6 py-3 text-left text-xs font-semibold text-violet-700 uppercase tracking-wider">Phone</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-violet-700 uppercase tracking-wider">Role</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-violet-700 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-violet-700 uppercase tracking-wider rounded-tr-xl">Action</th>
        </tr>
      </thead>
      
      <!-- Table Body (Target for JS rendering) -->
      <tbody id="user-table-body" class="bg-white divide-y divide-gray-100">
        <!-- Content dynamically rendered by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls (Target for JS rendering) -->
  <div id="pagination-controls" class="flex items-center justify-between mt-4">
    <!-- Summary and controls rendered by JS -->
  </div>
</div>

<script define:vars={{ usersJson, itemsPerPage }}>
    // --- Client-Side JavaScript Logic for Search and Pagination ---

    const ITEMS_PER_PAGE = itemsPerPage || 10;
    let allUsers = [];
    let filteredUsers = [];
    let currentPage = 1;

    // Utility function to map role to Tailwind classes (Duplicated from frontmatter)
    const getRoleClasses = (role) => {
        switch (role) {
            case 'admin':
                return 'bg-red-100 text-red-800';
            case 'employer':
                return 'bg-blue-100 text-blue-800';
            case 'editor':
                return 'bg-yellow-100 text-yellow-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // Utility function to map status to Tailwind classes
    const getStatusClasses = (status) => {
        switch (status) {
            case 'active':
                return 'bg-green-100 text-green-800';
            case 'inactive':
                return 'bg-red-100 text-red-800';
            case 'pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'suspended':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // Function to filter users based on the query
    const searchUsers = (query) => {
        if (!query) return allUsers;
        const lowerQuery = query.toLowerCase();
        return allUsers.filter(user => 
            (user.name && user.name.toLowerCase().includes(lowerQuery)) ||
            (user.email && user.email.toLowerCase().includes(lowerQuery)) ||
            (user.phoneNumber && user.phoneNumber.toLowerCase().includes(lowerQuery))
        );
    }

    // Function to render the table rows for the current page
    const renderTable = () => {
        const tableBody = document.getElementById('user-table-body');
        const paginationControls = document.getElementById('pagination-controls');
        
        if (!tableBody || !paginationControls) return;

        // Calculate slice indices
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

        // Render Table Rows
        if (paginatedUsers.length === 0) {
             tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-10 text-center text-gray-500 text-lg italic">
                        No users found matching your search criteria.
                    </td>
                </tr>
            `;
        } else {
            tableBody.innerHTML = paginatedUsers.map(user => `
                <tr class="hover:bg-gray-50 transition duration-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.email}</td>
                    <td class="hidden sm:table-cell px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.phoneNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span 
                            class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full capitalize ${getRoleClasses(user.role)}"
                        >
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span 
                            class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full capitalize ${getStatusClasses(user.status)}"
                            >
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex space-x-3">
                        <a href="/admin/users/${user.id}" class="text-violet-600 hover:text-violet-900 transition duration-150 ease-in-out font-medium" title="View Details">View</a>
                        <a href="/admin/users/${user.id}/edit" class="text-blue-600 hover:text-blue-900 transition duration-150 ease-in-out font-medium" title="Edit User">Edit</a>
                        <a href="/admin/users/${user.id}/delete" class="text-red-600 hover:text-red-900 transition duration-150 ease-in-out font-medium" title="Delete User">Delete</a>
                    </td>
                </tr>
            `).join('');
        }
        
        // Render Pagination Controls
        renderPagination(paginationControls);
    }
    
    // Function to render pagination buttons and summary
    const renderPagination = (container) => {
        const totalPages = Math.ceil(filteredUsers.length / ITEMS_PER_PAGE);
        const totalItems = filteredUsers.length;
        
        if (totalPages <= 1) {
            container.innerHTML = `<p class="text-sm text-gray-700">Showing <strong>${totalItems}</strong> results</p>`;
            return;
        }

        const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
        const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
        
        container.innerHTML = `
            <div class="text-sm text-gray-700">
                Showing <span class="font-medium">${startItem}</span> to <span class="font-medium">${endItem}</span> of <span class="font-medium">${totalItems}</span> results
            </div>
            <div class="flex space-x-2">
                <button id="prev-page" class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === 1 ? 'disabled' : ''}>
                    Previous
                </button>
                <span class="px-3 py-1 text-sm font-medium text-gray-700">Page ${currentPage} of ${totalPages}</span>
                <button id="next-page" class="px-3 py-1 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}" ${currentPage === totalPages ? 'disabled' : ''}>
                    Next
                </button>
            </div>
        `;
        
        // Attach listeners to new buttons
        document.getElementById('prev-page')?.addEventListener('click', () => handlePageChange(currentPage - 1));
        document.getElementById('next-page')?.addEventListener('click', () => handlePageChange(currentPage + 1));
    }
    
    // Handler for page changes
    const handlePageChange = (newPage) => {
        const totalPages = Math.ceil(filteredUsers.length / ITEMS_PER_PAGE);
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTable();
        }
    }

    // Handler for search input
    const handleSearch = (event) => {
        const query = event.target.value;
        filteredUsers = searchUsers(query);
        currentPage = 1; // Reset to first page on new search
        renderTable();
    }
    
    // Initialization function
    const init = () => {
        try {
            allUsers = JSON.parse(usersJson);
            filteredUsers = allUsers; // Start with all users visible
            renderTable();
            
            // Attach search listener
            document.getElementById('user-search-input')?.addEventListener('input', handleSearch);

        } catch (e) {
            console.error("Failed to initialize user table:", e);
            document.getElementById('user-table-body').innerHTML = `
                <tr><td colspan="5" class="px-6 py-10 text-center text-red-500 text-lg">Error loading user data.</td></tr>
            `;
        }
    }
    
    // Initialize the application logic
    init();

</script>