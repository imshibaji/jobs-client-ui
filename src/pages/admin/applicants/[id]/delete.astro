---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { Applicant } from "@/utils/types/Applicant";
import { useHttpClient } from "@/utils/useHttpClient";
import { APP_URL } from "astro:env/server";

// --- Server-side Data Fetching and Request Handling ---

const { id } = Astro.params;
const token = Astro.cookies.get('token')?.value as string;
const backUrl = Astro.url.searchParams.get('backUrl') || '/admin/applicants';

// 1. Handle the POST request (The deletion action)
if (Astro.request.method === 'POST') {
    try {
        // Perform the deletion using the token and user ID
        await useHttpClient(token).delete(APP_URL + `/applicants/${id}`);
        
        // Redirect the user back after successful deletion
        return Astro.redirect(backUrl);
    } catch (error) {
        console.error("Failed to delete applicant:", error);
        // You might want to redirect to an error page or back with a message
        return Astro.redirect(`${backUrl}?error=deletionFailed`); 
    }
}

// 2. Handle the GET request (Display Confirmation Page)
let applicant: Applicant | null = null;
try {
    applicant = await useHttpClient(token).get(APP_URL + `/applicants/${id}`).then(res => res.json()) as Applicant;
} catch (error) {
    console.error("Failed to fetch user data:", error);
    // If user data cannot be fetched, redirect or show an error
    return Astro.redirect('/admin/applicants?error=userNotFound');
}

if (!applicant) {
    return Astro.redirect('/admin/applicants?error=userNotFound');
}
---

<AdminLayout>
  <div class="mt-4 max-w-2xl mx-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Applicant Delete Confirmation</h2>
    <p class="text-gray-700 mb-6">
        You are about to permanently delete the applicant listed below. This action cannot be undone.
    </p>

    <!-- User Information Card -->
    <div class="bg-white border-2 border-red-200 rounded-xl shadow-lg overflow-hidden mb-6">
      <div class="p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-3 border-b pb-2 text-red-600">
            Confirm Deletion for:
        </h3>
        <p class="text-gray-700"><strong>User ID:</strong> <span class="font-mono text-sm bg-gray-100 p-1 rounded">{applicant.id}</span></p>
        <p class="text-gray-700"><strong>Name:</strong> {applicant.name}</p>
        <p class="text-gray-700"><strong>Skills:</strong> {applicant.skills}</p>
        <p class="text-gray-700"><strong>Experience:</strong> {applicant.experience}</p>
        <p class="text-gray-700"><strong>Gender:</strong> <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded">{applicant.gender}</span></p>
      </div>
    </div>
    
    <!-- The Deletion Form (POST submission) -->
    <div>
      <form method="POST" class="p-4 bg-red-50 rounded-lg border border-red-300"> 
        <p class="text-red-800 font-semibold mb-4">
            Are you absolutely sure you want to delete this applicant?
        </p>
        <button 
            type="submit" 
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150"
        >
            Yes, Permanently Delete Applicant
        </button>
      </form>
    </div>
  </div>
  
  <div class="mt-6 text-center">
    <a href={backUrl} class="text-violet-600 hover:text-violet-800 hover:underline font-medium p-2">
        ‚Üê Cancel and Go Back to Applicant List
    </a>
  </div>
</AdminLayout>